# InviteCodeManager Development Guidelines

## Build/Configuration Instructions

### Prerequisites

- **Rust**: Version 1.85.0 (specified in `rust-toolchain.toml`)
- **Components**: rustfmt, clippy (automatically installed with the toolchain)
- **Diesel CLI**: Required for database migrations
  ```bash
  cargo install diesel_cli --no-default-features --features sqlite
  ```

### Environment Setup

1. Copy the sample environment file:
   ```bash
   cp .env.sample .env
   ```

2. Configure required environment variables in `.env`:
   ```bash
   # PDS-related variables (REQUIRED)
   PDS_ADMIN_PASSWORD="your_pds_admin_password"
   PDS_ENDPOINT="http://your-pds-endpoint"
   
   # Manager-related variables (with defaults)
   DATABASE_URL="invitemanager.sqlite"  # SQLite database file path
   DB_MIN_IDLE="1"                      # Minimum idle connections in pool
   SERVER_PORT="9090"                   # HTTP server port
   WORKER_COUNT="2"                     # Actix-web worker threads
   SALT="salt_password"                 # Password hashing salt
   ```

### Database Setup

1. Run migrations to create the database schema:
   ```bash
   diesel migration run
   ```
   This generates `src/schema.rs` with the database table definitions.

2. Create an admin user (interactive CLI):
   ```bash
   cargo run create-user
   ```

### Building the Project

```bash
# Development build
cargo build

# Release build
cargo build --release

# Run the application
cargo run
```

### Docker Build

```bash
# Build Docker image
docker build -t invite-code-manager .

# Run with environment file
docker run --env-file .env -p 9090:9090 invite-code-manager
```

## Testing Information

### Test Configuration

- Tests are located in `src/lib.rs` under the `#[cfg(test)]` module
- The project uses Rust's built-in testing framework
- Database schema must be generated before running tests

### Running Tests

```bash
# Run all tests
cargo test

# Run tests with output
cargo test -- --nocapture

# Run specific test
cargo test test_basic_functionality
```

### Adding New Tests

1. Add test functions in the `tests` module in `src/lib.rs`:
   ```rust
   #[test]
   fn test_your_functionality() {
       // Your test code here
       assert_eq!(expected, actual);
   }
   ```

2. For integration tests, create files in a `tests/` directory at project root
3. For testing database functionality, ensure migrations are run first

### Example Test Structure

The project includes basic tests demonstrating:

- Simple functionality testing
- Config struct creation and validation
- Module integration testing

Current test output shows successful execution:

```
running 2 tests
test tests::test_basic_functionality ... ok
test tests::test_config_creation ... ok
test result: ok. 2 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out
```

## Additional Development Information

### Project Structure

```
src/
├── main.rs           # Application entry point and server setup
├── lib.rs            # Library crate root with test modules
├── cli.rs            # CLI commands (user creation)
├── config.rs         # Configuration structures
├── error.rs          # Custom error types
├── helper.rs         # Utility functions for OTP and user management
├── schema.rs         # Generated by Diesel (database schema)
├── user.rs           # User models and authentication
└── routes/           # HTTP route handlers
    ├── create_invite_codes.rs
    ├── disable_invite_codes.rs
    ├── generate_otp.rs
    ├── get_invite_codes.rs
    ├── login.rs
    ├── validate_otp.rs
    └── verify_otp.rs
```

### Key Dependencies

- **actix-web**: Web framework for HTTP server
- **diesel**: ORM and database migrations with SQLite
- **actix-session**: Session management with cookie storage
- **rust-argon2**: Password hashing
- **totp-rs**: Time-based OTP implementation
- **reqwest**: HTTP client for PDS communication
- **tracing**: Structured logging

### Code Style Guidelines

- The project uses Rust edition 2024
- Follow standard Rust naming conventions (note: main crate should be `invite_code_manager` instead
  of `InviteCodeManager`)
- Use `rustfmt` for code formatting: `cargo fmt`
- Use `clippy` for linting: `cargo clippy`

### Database Schema

The application uses a single table `invite_code_admin`:

- `rowid`: Integer primary key
- `username`: Text (unique identifier)
- `password`: Text (Argon2 hashed)
- `otp_base32`: Nullable text (TOTP secret)
- `otp_auth_url`: Nullable text (QR code URL)
- `otp_enabled`: Integer boolean
- `otp_verified`: Integer boolean

### Development Workflow

1. Make code changes
2. Run `cargo fmt` to format code
3. Run `cargo clippy` to check for issues
4. Run `cargo test` to verify tests pass
5. Test manually with `cargo run`
6. For database changes, create new migrations with `diesel migration generate`

### Debugging Tips

- Use `RUST_LOG=debug cargo run` for detailed logging
- Database issues often require re-running migrations
- Check environment variables are properly set
- OTP functionality requires proper time synchronization
- PDS connection requires valid admin credentials

### API Endpoints

The application exposes these routes:

- `POST /login` - User authentication
- `POST /generate-otp` - Generate OTP secret
- `POST /verify-otp` - Verify OTP setup
- `POST /validate-otp` - Validate OTP token
- `POST /create-invite-codes` - Create new invite codes
- `GET /get-invite-codes` - Retrieve invite codes
- `POST /disable-invite-codes` - Disable invite codes